<%
	# location may not end with /, except when location == '/'
	# only in the latter case, alias has to have a slash at the end
	location = @url_path.sub(/\/*$/,'')
	alias = @destination.sub(/\/*$/,'')
	if location == '' then
		location = '/'
		alias += '/'
	end
-%>
location <%= location %> {
	alias <%= @base_dir %>/apps/<%= alias %>;
	index index.php;

	location ~ [^/]\.php(/|$) {
		fastcgi_split_path_info ^<%= location %>(.+?\.php)(/.*)?$;
		if (!-f $document_root$fastcgi_script_name) {
			return 404;
		}

		fastcgi_pass unix:<%= @base_dir %>/run/php5-fpm-<%= @destination %>.sock;
		fastcgi_index index.php;
		include /etc/nginx/php5-fpm_params;
	}
}
